@model QuestionResponse

<link rel="stylesheet" href="~/css/AddForm.css" />

<div class="container mt-5" style="max-width:85%;">
    <h1 class="mb-4">Оновити запитання</h1>
    <form action="/questions/@Model.Id/update?returnUrl=@ViewBag.ReturnUrl" method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
        <input type="hidden" name="Id" value="@Model.Id" />

        <div class="form-group mb-3">
            <label for="Content" class="mb-2">Текст запитання:</label>
            <textarea class="form-control" id="Content" name="Content" rows="3" maxlength="3000" placeholder="Введіть текст запитання" required>@Model.Content</textarea>
            <div class="invalid-feedback" id="ContentFeedback"></div>
        </div>

        <div class="form-group mb-3">
            <label for="Explanation" class="mb-2">Пояснення:</label>
            <textarea class="form-control" id="Explanation" name="Explanation" rows="3" maxlength="3000" placeholder="Введіть текст пояснення" required>@Model.Explanation</textarea>
            <div class="invalid-feedback" id="ExplanationFeedback"></div>
        </div>

        <div class="form-group mb-3">
            <label for="TicketNumber" class="mb-2">Номер білету (не обов'язково):</label>
            <input type="number" class="form-control" id="TicketNumber" name="TitleDetails.TicketNumber" placeholder="Введіть номер білету" min="0" value="@Model.TitleDetails.TicketNumber">
            <div class="invalid-feedback" id="TicketNumberFeedback"></div>
        </div>

        <div class="form-group mb-3">
            <label for="QuestionNumber" class="mb-2">Номер запитання (не обов'язково):</label>
            <input type="number" class="form-control" id="QuestionNumber" name="TitleDetails.QuestionNumber" placeholder="Введіть номер запитання" min="0" value="@Model.TitleDetails.QuestionNumber">
            <div class="invalid-feedback" id="QuestionNumberFeedback"></div>
        </div>

        <div class="form-group mb-4">
            <label for="TopicsIds" class="mb-2">Тема:</label>
            <select style="height: 50vh;" multiple class="form-control" id="TopicsIds" name="TopicsIds" required>
                @foreach (var topic in ViewBag.AllTopics as IEnumerable<TopicResponse>)
                {
                    <option class="mb-2 mt-2" value="@topic.Id"
                    @((ViewBag.QuestionTopics as IEnumerable<TopicResponse>).Any(qt =>
                        qt.Id == topic.Id) ? "selected" : "")>
                        @topic.Number. @topic.Title
                    </option>
                }
            </select>
            <div class="invalid-feedback"></div>
        </div>

        <div class="form-group mb-3">
            <label for="Image" class="form-label">Малюнок (не обов'язково):</label>
            <input name="Image" class="form-control custom-file-input" type="file" id="Image">
        </div>

        @if (Model.ImageUri != null)
        {
            <div class="mb-4">
                <label for="ImagePreview" class="form-label">Попередній перегляд існуючого малюнка:</label>
                <br />
                <img src="@Model.ImageUri" alt="Image Preview" style="max-width: 100%; height: auto;" />
            </div>

            <div class="form-group mb-3">
                <input type="checkbox" class="custom-control-input" name="RemoveOldImageIfNewImageMissing" value="true" checked>
                <label class="custom-control-label" for="RemoveOldImageIfNewImageMissing">Видалити існуючий малюнок, якщо новий не задано</label>
                <input type="hidden" name="RemoveOldImageIfNewImageMissing" value="false">
            </div>
        }

       
        

        <div id="answers" class="mt-5 mb-5">
            @for (int i = 0; i < Model.Answers.Count(); i++)
            {
                var answer = Model.Answers.ElementAt(i);
                <div class="form-group answer-item mb-4" data-index="@i">
                    <label for="Answer@(i + 1)" class="mb-2">Відповідь @(i + 1)</label>
                    <input type="text" class="form-control" id="Answer@(i + 1)" name="Answers[@i].Text" placeholder="Введіть текст відповіді" required value="@answer.Text">
                    <div class="invalid-feedback"></div>
                    <div class="custom-control custom-checkbox mt-2">
                        <input type="checkbox" class="custom-control-input" id="IsCorrect@(i + 1)" name="Answers[@i].IsCorrect" value="true" @(answer.IsCorrect ? "checked" : "")>
                        <label class="custom-control-label" for="IsCorrect@(i + 1)">Правильна</label>
                        <input type="hidden" name="Answers[@i].IsCorrect" value="false">
                    </div>
                    <button type="button" class="btn btn-danger btn-sm mt-2 remove-answer" @(Model.Answers.Count() == 1 ? "style=display:none;" : "")>Видалити</button>
                </div>
            }
        </div>

        <button type="button" class="btn btn-secondary mb-3" id="addAnswer">Додати нову відповідь</button>
        <br />
        <button type="submit" class="btn btn-primary col-lg-4 col-md-8 col-12 mb-4">Оновити</button>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        'use strict';

        document.querySelector('.needs-validation').addEventListener('submit', function (event) {
            var isValid = true;

            var contentField = document.getElementById('Content');
            var contentFeedback = document.getElementById('ContentFeedback');
            var explanationField = document.getElementById('Explanation');
            var explanationFeedback = document.getElementById('ExplanationFeedback');
            var ticketNumberField = document.getElementById('TicketNumber');
            var ticketNumberFeedback = document.getElementById('TicketNumberFeedback');
            var questionNumberField = document.getElementById('QuestionNumber');
            var questionNumberFeedback = document.getElementById('QuestionNumberFeedback');
            var topicsSelect = document.getElementById('TopicsIds');
            var topicsFeedback = topicsSelect.nextElementSibling;

            // Reset previous validation states
            contentFeedback.textContent = '';
            explanationFeedback.textContent = '';
            ticketNumberFeedback.textContent = '';
            questionNumberFeedback.textContent = '';
            topicsFeedback.textContent = '';
            contentField.classList.remove('is-invalid', 'is-valid');
            explanationField.classList.remove('is-invalid', 'is-valid');
            ticketNumberField.classList.remove('is-invalid', 'is-valid');
            questionNumberField.classList.remove('is-invalid', 'is-valid');
            topicsSelect.classList.remove('is-invalid', 'is-valid');
            document.querySelectorAll('#answers .answer-item input[type="text"]').forEach(input => input.classList.remove('is-invalid', 'is-valid'));

            if (contentField.value.trim() === '') {
                contentFeedback.textContent = 'Будь ласка, введіть текст запитання.';
                contentField.classList.add('is-invalid');
                isValid = false;
            } else if (contentField.value.length > 3000) {
                contentFeedback.textContent = 'Довжина тексту не повинна перевищувати 3000 символів.';
                contentField.classList.add('is-invalid');
                isValid = false;
            } else {
                contentField.classList.add('is-valid');
            }

            if (explanationField.value.trim() === '') {
                explanationFeedback.textContent = 'Будь ласка, введіть пояснення.';
                explanationField.classList.add('is-invalid');
                isValid = false;
            } else if (explanationField.value.length > 3000) {
                explanationFeedback.textContent = 'Довжина пояснення не повинна перевищувати 3000 символів.';
                explanationField.classList.add('is-invalid');
                isValid = false;
            } else {
                explanationField.classList.add('is-valid');
            }

            if (ticketNumberField.value < 0) {
                ticketNumberFeedback.textContent = 'Номер білету не може бути від\'ємним.';
                ticketNumberField.classList.add('is-invalid');
                isValid = false;
            } else if (ticketNumberField.value && !questionNumberField.value) {
                questionNumberFeedback.textContent = 'Номер питання обов\'язковий, якщо введено номер білету.';
                questionNumberField.classList.add('is-invalid');
                isValid = false;
            } else if (!ticketNumberField.value && questionNumberField.value) {
                ticketNumberFeedback.textContent = 'Номер білету обов\'язковий, якщо введено номер питання.';
                ticketNumberField.classList.add('is-invalid');
                isValid = false;
            } else if (questionNumberField.value < 0) {
                questionNumberFeedback.textContent = 'Номер запитання не може бути від\'ємним.';
                questionNumberField.classList.add('is-invalid');
                isValid = false;
            } else {
                ticketNumberField.classList.add('is-valid');
                questionNumberField.classList.add('is-valid');
            }

            if (topicsSelect.selectedOptions.length === 0) {
                topicsFeedback.textContent = 'Будь ласка, оберіть хоча б одну тему.';
                topicsSelect.classList.add('is-invalid');
                isValid = false;
            } else {
                topicsSelect.classList.add('is-valid');
            }

            var answerFields = document.querySelectorAll('#answers .answer-item input[type="text"]');
            answerFields.forEach(input => {
                if (input.value.trim() === '') {
                    input.classList.add('is-invalid');
                    isValid = false;
                } else if (input.value.length > 300) {
                    input.nextElementSibling.textContent = 'Довжина відповіді не повинна перевищувати 300 символів.';
                    input.classList.add('is-invalid');
                    isValid = false;
                } else {
                    input.classList.add('is-valid');
                }
            });

            var isCorrectChecked = false;
            document.querySelectorAll('#answers .answer-item input[type="checkbox"]').forEach(checkbox => {
                if (checkbox.checked) {
                    isCorrectChecked = true;
                }
            });

            if (!isCorrectChecked) {
                isValid = false;
                const firstAnswer = document.querySelector('#answers .answer-item');
                const feedback = firstAnswer.querySelector('.invalid-feedback');
                feedback.textContent = 'Будь ласка, позначте принаймні одну відповідь як правильну.';
                firstAnswer.querySelector('input[type="text"]').classList.add('is-invalid');
            }

            if (!isValid) {
                event.preventDefault();
                event.stopPropagation();
            }

            document.querySelector('.needs-validation').classList.add('was-validated');
        });

        document.getElementById('addAnswer').addEventListener('click', function () {
            var answerCount = document.querySelectorAll('#answers .answer-item').length;
            var answerContainer = document.getElementById('answers');
            var newAnswerHtml = `
                    <div class="form-group answer-item mb-4" data-index="${answerCount}">
                        <label for="Answer${answerCount + 1}" class="mb-2">Відповідь ${answerCount + 1}</label>
                        <input type="text" class="form-control" id="Answer${answerCount + 1}" name="Answers[${answerCount}].Text" placeholder="Введіть текст відповіді" required>
                        <div class="invalid-feedback"></div>
                        <div class="custom-control custom-checkbox mt-2">
                            <input type="checkbox" class="custom-control-input" id="IsCorrect${answerCount + 1}" name="Answers[${answerCount}].IsCorrect" value="true">
                            <label class="custom-control-label" for="IsCorrect${answerCount + 1}">Правильна</label>
                            <input type="hidden" name="Answers[${answerCount}].IsCorrect" value="false">
                        </div>
                        <button type="button" class="btn btn-danger btn-sm mt-2 remove-answer">Видалити</button>
                    </div>`;
            answerContainer.insertAdjacentHTML('beforeend', newAnswerHtml);
        });

        document.getElementById('answers').addEventListener('click', function (event) {
            if (event.target.classList.contains('remove-answer')) {
                if (document.querySelectorAll('#answers .answer-item').length > 1) {
                    event.target.parentElement.remove();
                    updateAnswerIndices();
                } else {
                    alert('Принаймні одне питання має залишитися.');
                }
            }
        });

        function updateAnswerIndices() {
            var answerItems = document.querySelectorAll('#answers .answer-item');
            answerItems.forEach((item, index) => {
                item.dataset.index = index;
                item.querySelector('label').textContent = `Відповідь ${index + 1}`;
                item.querySelector('input[type="text"]').id = `Answer${index + 1}`;
                item.querySelector('input[type="text"]').name = `Answers[${index}].Text`;
                item.querySelector('input[type="checkbox"]').id = `IsCorrect${index + 1}`;
                item.querySelector('input[type="checkbox"]').name = `Answers[${index}].IsCorrect`;
                item.querySelector('input[type="hidden"]').name = `Answers[${index}].IsCorrect`;
            });
        }

        function toggleRemoveButton() {
            let answerItems = document.querySelectorAll('#answers .answer-item');
            let removeButtons = document.querySelectorAll('.remove-answer');
            if (answerItems.length === 1) {
                removeButtons.forEach(button => button.style.display = 'none');
            } else {
                removeButtons.forEach(button => button.style.display = 'inline-block');
            }
        }

        toggleRemoveButton();
    });
</script>
